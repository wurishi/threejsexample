var Wt=Object.defineProperty;var Gt=(l,e,n)=>e in l?Wt(l,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[e]=n;var Q=(l,e,n)=>(Gt(l,typeof e!="symbol"?e+"":e,n),n);import{au as qt,V as r,O as lt,Q as O,aJ as Ft,q as wt,c as W,z as At,ap as v,B as M,i as ft,aw as _t,b as s,aN as tt,N as Y,av as Qt,aO as G,ak as Rt,G as Ut,C as et,j as Bt,E as Vt,ao as Nt,aP as Kt,aQ as Jt}from"./example-e9f3c815.js";import{O as $t}from"./OrbitControls-94bee5b1.js";import{D as te,a as gt}from"./draco_decoder-2026588a.js";import{G as ee}from"./GLTFLoader-27d86567.js";import{G as ie}from"./index-ba66c6be.js";const Z=new qt,P=new r,C=new r,u=new O,bt={X:new r(1,0,0),Y:new r(0,1,0),Z:new r(0,0,1)},ht={type:"change"},xt={type:"mouseDown"},Mt={type:"mouseUp",mode:null},St={type:"objectChange"};class ne extends lt{constructor(e,n){super(),n===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),n=document),this.isTransformControls=!0,this.visible=!1,this.domElement=n,this.domElement.style.touchAction="none";const i=new he;this._gizmo=i,this.add(i);const o=new ce;this._plane=o,this.add(o);const a=this;function t(y,E){let z=E;Object.defineProperty(a,y,{get:function(){return z!==void 0?z:E},set:function(H){z!==H&&(z=H,o[y]=H,i[y]=H,a.dispatchEvent({type:y+"-changed",value:H}),a.dispatchEvent(ht))}}),a[y]=E,o[y]=E,i[y]=E}t("camera",e),t("object",void 0),t("enabled",!0),t("axis",null),t("mode","translate"),t("translationSnap",null),t("rotationSnap",null),t("scaleSnap",null),t("space","world"),t("size",1),t("dragging",!1),t("showX",!0),t("showY",!0),t("showZ",!0);const c=new r,h=new r,m=new O,p=new O,g=new r,_=new O,I=new r,b=new r,w=new r,d=0,x=new r;t("worldPosition",c),t("worldPositionStart",h),t("worldQuaternion",m),t("worldQuaternionStart",p),t("cameraPosition",g),t("cameraQuaternion",_),t("pointStart",I),t("pointEnd",b),t("rotationAxis",w),t("rotationAngle",d),t("eye",x),this._offset=new r,this._startNorm=new r,this._endNorm=new r,this._cameraScale=new r,this._parentPosition=new r,this._parentQuaternion=new O,this._parentQuaternionInv=new O,this._parentScale=new r,this._worldScaleStart=new r,this._worldQuaternionInv=new O,this._worldScale=new r,this._positionStart=new r,this._quaternionStart=new O,this._scaleStart=new r,this._getPointer=oe.bind(this),this._onPointerDown=ae.bind(this),this._onPointerHover=se.bind(this),this._onPointerMove=re.bind(this),this._onPointerUp=le.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;Z.setFromCamera(e,this.camera);const n=ct(this._gizmo.picker[this.mode],Z);n?this.axis=n.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e.button!==0)&&this.axis!==null){Z.setFromCamera(e,this.camera);const n=ct(this._plane,Z,!0);n&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(n.point).sub(this.worldPositionStart)),this.dragging=!0,xt.mode=this.mode,this.dispatchEvent(xt)}}pointerMove(e){const n=this.axis,i=this.mode,o=this.object;let a=this.space;if(i==="scale"?a="local":(n==="E"||n==="XYZE"||n==="XYZ")&&(a="world"),o===void 0||n===null||this.dragging===!1||e.button!==-1)return;Z.setFromCamera(e,this.camera);const t=ct(this._plane,Z,!0);if(t){if(this.pointEnd.copy(t.point).sub(this.worldPositionStart),i==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),a==="local"&&n!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),n.indexOf("X")===-1&&(this._offset.x=0),n.indexOf("Y")===-1&&(this._offset.y=0),n.indexOf("Z")===-1&&(this._offset.z=0),a==="local"&&n!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),o.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(a==="local"&&(o.position.applyQuaternion(u.copy(this._quaternionStart).invert()),n.search("X")!==-1&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),n.search("Y")!==-1&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),n.search("Z")!==-1&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.position.applyQuaternion(this._quaternionStart)),a==="world"&&(o.parent&&o.position.add(P.setFromMatrixPosition(o.parent.matrixWorld)),n.search("X")!==-1&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),n.search("Y")!==-1&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),n.search("Z")!==-1&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.parent&&o.position.sub(P.setFromMatrixPosition(o.parent.matrixWorld))));else if(i==="scale"){if(n.search("XYZ")!==-1){let c=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(c*=-1),C.set(c,c,c)}else P.copy(this.pointStart),C.copy(this.pointEnd),P.applyQuaternion(this._worldQuaternionInv),C.applyQuaternion(this._worldQuaternionInv),C.divide(P),n.search("X")===-1&&(C.x=1),n.search("Y")===-1&&(C.y=1),n.search("Z")===-1&&(C.z=1);o.scale.copy(this._scaleStart).multiply(C),this.scaleSnap&&(n.search("X")!==-1&&(o.scale.x=Math.round(o.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),n.search("Y")!==-1&&(o.scale.y=Math.round(o.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),n.search("Z")!==-1&&(o.scale.z=Math.round(o.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(i==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const c=20/this.worldPosition.distanceTo(P.setFromMatrixPosition(this.camera.matrixWorld));n==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1):n==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(P.copy(this.rotationAxis).cross(this.eye))*c):(n==="X"||n==="Y"||n==="Z")&&(this.rotationAxis.copy(bt[n]),P.copy(bt[n]),a==="local"&&P.applyQuaternion(this.worldQuaternion),this.rotationAngle=this._offset.dot(P.cross(this.eye).normalize())*c),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),a==="local"&&n!=="E"&&n!=="XYZE"?(o.quaternion.copy(this._quaternionStart),o.quaternion.multiply(u.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),o.quaternion.copy(u.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),o.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ht),this.dispatchEvent(St)}}pointerUp(e){e.button===0&&(this.dragging&&this.axis!==null&&(Mt.mode=this.mode,this.dispatchEvent(Mt)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ht),this.dispatchEvent(St),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Z}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function oe(l){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:l.button};{const e=this.domElement.getBoundingClientRect();return{x:(l.clientX-e.left)/e.width*2-1,y:-(l.clientY-e.top)/e.height*2+1,button:l.button}}}function se(l){if(this.enabled)switch(l.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(l));break}}function ae(l){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(l.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(l)),this.pointerDown(this._getPointer(l)))}function re(l){this.enabled&&this.pointerMove(this._getPointer(l))}function le(l){this.enabled&&(this.domElement.releasePointerCapture(l.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(l)))}function ct(l,e,n){const i=e.intersectObject(l,!0);for(let o=0;o<i.length;o++)if(i[o].object.visible||n)return i[o];return!1}const it=new Ft,f=new r(0,1,0),vt=new r(0,0,0),Pt=new wt,nt=new O,at=new O,X=new r,It=new wt,B=new r(1,0,0),D=new r(0,1,0),V=new r(0,0,1),ot=new r,q=new r,F=new r;class he extends lt{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new W({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=new At({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=e.clone();i.opacity=.15;const o=n.clone();o.opacity=.5;const a=e.clone();a.color.setHex(16711680);const t=e.clone();t.color.setHex(65280);const c=e.clone();c.color.setHex(255);const h=e.clone();h.color.setHex(16711680),h.opacity=.5;const m=e.clone();m.color.setHex(65280),m.opacity=.5;const p=e.clone();p.color.setHex(255),p.opacity=.5;const g=e.clone();g.opacity=.25;const _=e.clone();_.color.setHex(16776960),_.opacity=.25,e.clone().color.setHex(16776960);const b=e.clone();b.color.setHex(7895160);const w=new v(0,.04,.1,12);w.translate(0,.05,0);const d=new M(.08,.08,.08);d.translate(0,.04,0);const x=new ft;x.setAttribute("position",new _t([0,0,0,1,0,0],3));const y=new v(.0075,.0075,.5,3);y.translate(0,.25,0);function E(k,N){const A=new G(k,.0075,3,64,N*Math.PI*2);return A.rotateY(Math.PI/2),A.rotateX(Math.PI/2),A}function z(){const k=new ft;return k.setAttribute("position",new _t([0,0,0,1,1,1],3)),k}const H={X:[[new s(w,a),[.5,0,0],[0,0,-Math.PI/2]],[new s(w,a),[-.5,0,0],[0,0,Math.PI/2]],[new s(y,a),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new s(w,t),[0,.5,0]],[new s(w,t),[0,-.5,0],[Math.PI,0,0]],[new s(y,t)]],Z:[[new s(w,c),[0,0,.5],[Math.PI/2,0,0]],[new s(w,c),[0,0,-.5],[-Math.PI/2,0,0]],[new s(y,c),null,[Math.PI/2,0,0]]],XYZ:[[new s(new tt(.1,0),g.clone()),[0,0,0]]],XY:[[new s(new M(.15,.15,.01),p.clone()),[.15,.15,0]]],YZ:[[new s(new M(.15,.15,.01),h.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s(new M(.15,.15,.01),m.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},Tt={X:[[new s(new v(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new s(new v(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new s(new v(.2,0,.6,4),i),[0,.3,0]],[new s(new v(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new s(new v(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new s(new v(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new s(new tt(.2,0),i)]],XY:[[new s(new M(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new s(new M(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s(new M(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},Yt={START:[[new s(new tt(.01,2),o),null,null,null,"helper"]],END:[[new s(new tt(.01,2),o),null,null,null,"helper"]],DELTA:[[new Y(z(),o),null,null,null,"helper"]],X:[[new Y(x,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Y(x,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Y(x,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},Ct={XYZE:[[new s(E(.5,1),b),null,[0,Math.PI/2,0]]],X:[[new s(E(.5,.5),a)]],Y:[[new s(E(.5,.5),t),null,[0,0,-Math.PI/2]]],Z:[[new s(E(.5,.5),c),null,[0,Math.PI/2,0]]],E:[[new s(E(.75,1),_),null,[0,Math.PI/2,0]]]},Ht={AXIS:[[new Y(x,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},Zt={XYZE:[[new s(new Qt(.25,10,8),i)]],X:[[new s(new G(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new s(new G(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new s(new G(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new s(new G(.75,.1,2,24),i)]]},Lt={X:[[new s(d,a),[.5,0,0],[0,0,-Math.PI/2]],[new s(y,a),[0,0,0],[0,0,-Math.PI/2]],[new s(d,a),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new s(d,t),[0,.5,0]],[new s(y,t)],[new s(d,t),[0,-.5,0],[0,0,Math.PI]]],Z:[[new s(d,c),[0,0,.5],[Math.PI/2,0,0]],[new s(y,c),[0,0,0],[Math.PI/2,0,0]],[new s(d,c),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new s(new M(.15,.15,.01),p),[.15,.15,0]]],YZ:[[new s(new M(.15,.15,.01),h),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s(new M(.15,.15,.01),m),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new s(new M(.1,.1,.1),g.clone())]]},Dt={X:[[new s(new v(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new s(new v(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new s(new v(.2,0,.6,4),i),[0,.3,0]],[new s(new v(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new s(new v(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new s(new v(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new s(new M(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new s(new M(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s(new M(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new s(new M(.2,.2,.2),i),[0,0,0]]]},zt={X:[[new Y(x,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Y(x,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Y(x,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function T(k){const N=new lt;for(const A in k)for(let j=k[A].length;j--;){const S=k[A][j][0].clone(),K=k[A][j][1],J=k[A][j][2],$=k[A][j][3],jt=k[A][j][4];S.name=A,S.tag=jt,K&&S.position.set(K[0],K[1],K[2]),J&&S.rotation.set(J[0],J[1],J[2]),$&&S.scale.set($[0],$[1],$[2]),S.updateMatrix();const yt=S.geometry.clone();yt.applyMatrix4(S.matrix),S.geometry=yt,S.renderOrder=1/0,S.position.set(0,0,0),S.rotation.set(0,0,0),S.scale.set(1,1,1),N.add(S)}return N}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=T(H)),this.add(this.gizmo.rotate=T(Ct)),this.add(this.gizmo.scale=T(Lt)),this.add(this.picker.translate=T(Tt)),this.add(this.picker.rotate=T(Zt)),this.add(this.picker.scale=T(Dt)),this.add(this.helper.translate=T(Yt)),this.add(this.helper.rotate=T(Ht)),this.add(this.helper.scale=T(zt)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const i=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:at;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let o=[];o=o.concat(this.picker[this.mode].children),o=o.concat(this.gizmo[this.mode].children),o=o.concat(this.helper[this.mode].children);for(let a=0;a<o.length;a++){const t=o[a];t.visible=!0,t.rotation.set(0,0,0),t.position.copy(this.worldPosition);let c;if(this.camera.isOrthographicCamera?c=(this.camera.top-this.camera.bottom)/this.camera.zoom:c=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),t.scale.set(1,1,1).multiplyScalar(c*this.size/4),t.tag==="helper"){t.visible=!1,t.name==="AXIS"?(t.visible=!!this.axis,this.axis==="X"&&(u.setFromEuler(it.set(0,0,0)),t.quaternion.copy(i).multiply(u),Math.abs(f.copy(B).applyQuaternion(i).dot(this.eye))>.9&&(t.visible=!1)),this.axis==="Y"&&(u.setFromEuler(it.set(0,0,Math.PI/2)),t.quaternion.copy(i).multiply(u),Math.abs(f.copy(D).applyQuaternion(i).dot(this.eye))>.9&&(t.visible=!1)),this.axis==="Z"&&(u.setFromEuler(it.set(0,Math.PI/2,0)),t.quaternion.copy(i).multiply(u),Math.abs(f.copy(V).applyQuaternion(i).dot(this.eye))>.9&&(t.visible=!1)),this.axis==="XYZE"&&(u.setFromEuler(it.set(0,Math.PI/2,0)),f.copy(this.rotationAxis),t.quaternion.setFromRotationMatrix(Pt.lookAt(vt,f,D)),t.quaternion.multiply(u),t.visible=this.dragging),this.axis==="E"&&(t.visible=!1)):t.name==="START"?(t.position.copy(this.worldPositionStart),t.visible=this.dragging):t.name==="END"?(t.position.copy(this.worldPosition),t.visible=this.dragging):t.name==="DELTA"?(t.position.copy(this.worldPositionStart),t.quaternion.copy(this.worldQuaternionStart),P.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),P.applyQuaternion(this.worldQuaternionStart.clone().invert()),t.scale.copy(P),t.visible=this.dragging):(t.quaternion.copy(i),this.dragging?t.position.copy(this.worldPositionStart):t.position.copy(this.worldPosition),this.axis&&(t.visible=this.axis.search(t.name)!==-1));continue}t.quaternion.copy(i),this.mode==="translate"||this.mode==="scale"?(t.name==="X"&&Math.abs(f.copy(B).applyQuaternion(i).dot(this.eye))>.99&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1),t.name==="Y"&&Math.abs(f.copy(D).applyQuaternion(i).dot(this.eye))>.99&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1),t.name==="Z"&&Math.abs(f.copy(V).applyQuaternion(i).dot(this.eye))>.99&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1),t.name==="XY"&&Math.abs(f.copy(V).applyQuaternion(i).dot(this.eye))<.2&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1),t.name==="YZ"&&Math.abs(f.copy(B).applyQuaternion(i).dot(this.eye))<.2&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1),t.name==="XZ"&&Math.abs(f.copy(D).applyQuaternion(i).dot(this.eye))<.2&&(t.scale.set(1e-10,1e-10,1e-10),t.visible=!1)):this.mode==="rotate"&&(nt.copy(i),f.copy(this.eye).applyQuaternion(u.copy(i).invert()),t.name.search("E")!==-1&&t.quaternion.setFromRotationMatrix(Pt.lookAt(this.eye,vt,D)),t.name==="X"&&(u.setFromAxisAngle(B,Math.atan2(-f.y,f.z)),u.multiplyQuaternions(nt,u),t.quaternion.copy(u)),t.name==="Y"&&(u.setFromAxisAngle(D,Math.atan2(f.x,f.z)),u.multiplyQuaternions(nt,u),t.quaternion.copy(u)),t.name==="Z"&&(u.setFromAxisAngle(V,Math.atan2(f.y,f.x)),u.multiplyQuaternions(nt,u),t.quaternion.copy(u))),t.visible=t.visible&&(t.name.indexOf("X")===-1||this.showX),t.visible=t.visible&&(t.name.indexOf("Y")===-1||this.showY),t.visible=t.visible&&(t.name.indexOf("Z")===-1||this.showZ),t.visible=t.visible&&(t.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),t.material._color=t.material._color||t.material.color.clone(),t.material._opacity=t.material._opacity||t.material.opacity,t.material.color.copy(t.material._color),t.material.opacity=t.material._opacity,this.enabled&&this.axis&&(t.name===this.axis||this.axis.split("").some(function(h){return t.name===h}))&&(t.material.color.setHex(16776960),t.material.opacity=1)}super.updateMatrixWorld(e)}}class ce extends s{constructor(){super(new Rt(1e5,1e5,2,2),new W({visible:!1,wireframe:!0,side:Ut,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let n=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(n="local"),ot.copy(B).applyQuaternion(n==="local"?this.worldQuaternion:at),q.copy(D).applyQuaternion(n==="local"?this.worldQuaternion:at),F.copy(V).applyQuaternion(n==="local"?this.worldQuaternion:at),f.copy(q),this.mode){case"translate":case"scale":switch(this.axis){case"X":f.copy(this.eye).cross(ot),X.copy(ot).cross(f);break;case"Y":f.copy(this.eye).cross(q),X.copy(q).cross(f);break;case"Z":f.copy(this.eye).cross(F),X.copy(F).cross(f);break;case"XY":X.copy(F);break;case"YZ":X.copy(ot);break;case"XZ":f.copy(F),X.copy(q);break;case"XYZ":case"E":X.set(0,0,0);break}break;case"rotate":default:X.set(0,0,0)}X.length()===0?this.quaternion.copy(this.cameraQuaternion):(It.lookAt(P.set(0,0,0),X,f),this.quaternion.setFromRotationMatrix(It)),super.updateMatrixWorld(e)}}const Et=new O,kt=new r,R=new r,Ot=new r,U=new r,pt=new r,st=new O,pe=new r,dt=new r,ut=new r,L=new wt;class de{constructor(e,n=[]){this.mesh=e,this.iks=n,this._valid()}update(){const e=this.iks;for(let n=0,i=e.length;n<i;n++)this.updateOne(e[n]);return this}updateOne(e){const n=this.mesh.skeleton.bones,i=Math,o=n[e.effector],a=n[e.target];kt.setFromMatrixPosition(a.matrixWorld);const t=e.links,c=e.iteration!==void 0?e.iteration:1;for(let h=0;h<c;h++){let m=!1;for(let p=0,g=t.length;p<g;p++){const _=n[t[p].index];if(t[p].enabled===!1)break;const I=t[p].limitation,b=t[p].rotationMin,w=t[p].rotationMax;_.matrixWorld.decompose(pt,st,pe),st.invert(),Ot.setFromMatrixPosition(o.matrixWorld),U.subVectors(Ot,pt),U.applyQuaternion(st),U.normalize(),R.subVectors(kt,pt),R.applyQuaternion(st),R.normalize();let d=R.dot(U);if(d>1?d=1:d<-1&&(d=-1),d=i.acos(d),!(d<1e-5)){if(e.minAngle!==void 0&&d<e.minAngle&&(d=e.minAngle),e.maxAngle!==void 0&&d>e.maxAngle&&(d=e.maxAngle),dt.crossVectors(U,R),dt.normalize(),Et.setFromAxisAngle(dt,d),_.quaternion.multiply(Et),I!==void 0){let x=_.quaternion.w;x>1&&(x=1);const y=i.sqrt(1-x*x);_.quaternion.set(I.x*y,I.y*y,I.z*y,x)}b!==void 0&&_.rotation.setFromVector3(ut.setFromEuler(_.rotation).max(b)),w!==void 0&&_.rotation.setFromVector3(ut.setFromEuler(_.rotation).min(w)),_.updateMatrixWorld(!0),m=!0}}if(!m)break}return this}createHelper(){return new Xt(this.mesh,this.iks)}_valid(){const e=this.iks,n=this.mesh.skeleton.bones;for(let i=0,o=e.length;i<o;i++){const a=e[i],t=n[a.effector],c=a.links;let h,m;h=t;for(let p=0,g=c.length;p<g;p++)m=n[c[p].index],h.parent!==m&&console.warn("THREE.CCDIKSolver: bone "+h.name+" is not the child of bone "+m.name),h=m}}}function rt(l,e){return ut.setFromMatrixPosition(l.matrixWorld).applyMatrix4(e)}function mt(l,e,n,i){const o=rt(n,i);l[e*3+0]=o.x,l[e*3+1]=o.y,l[e*3+2]=o.z}class Xt extends lt{constructor(e,n=[],i=.25){super(),this.root=e,this.iks=n,this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.sphereGeometry=new Qt(i,16,8),this.targetSphereMaterial=new W({color:new et(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new W({color:new et(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new W({color:new et(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new At({color:new et(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init()}updateMatrixWorld(e){const n=this.root;if(this.visible){let i=0;const o=this.iks,a=n.skeleton.bones;L.copy(n.matrixWorld).invert();for(let t=0,c=o.length;t<c;t++){const h=o[t],m=a[h.target],p=a[h.effector],g=this.children[i++],_=this.children[i++];g.position.copy(rt(m,L)),_.position.copy(rt(p,L));for(let w=0,d=h.links.length;w<d;w++){const x=h.links[w],y=a[x.index];this.children[i++].position.copy(rt(y,L))}const I=this.children[i++],b=I.geometry.attributes.position.array;mt(b,0,m,L),mt(b,1,p,L);for(let w=0,d=h.links.length;w<d;w++){const x=h.links[w],y=a[x.index];mt(b,w+2,y,L)}I.geometry.attributes.position.needsUpdate=!0}}this.matrix.copy(n.matrixWorld),super.updateMatrixWorld(e)}dispose(){this.sphereGeometry.dispose(),this.targetSphereMaterial.dispose(),this.effectorSphereMaterial.dispose(),this.linkSphereMaterial.dispose(),this.lineMaterial.dispose();const e=this.children;for(let n=0;n<e.length;n++){const i=e[n];i.isLine&&i.geometry.dispose()}}_init(){const e=this,n=this.iks;function i(h){const m=new ft,p=new Float32Array((2+h.links.length)*3);return m.setAttribute("position",new Bt(p,3)),m}function o(){return new s(e.sphereGeometry,e.targetSphereMaterial)}function a(){return new s(e.sphereGeometry,e.effectorSphereMaterial)}function t(){return new s(e.sphereGeometry,e.linkSphereMaterial)}function c(h){return new Y(i(h),e.lineMaterial)}for(let h=0,m=n.length;h<m;h++){const p=n[h];this.add(o()),this.add(a());for(let g=0,_=p.links.length;g<_;g++)this.add(t());this.add(c(p))}}}class ge extends Vt{constructor(){super(...arguments);Q(this,"OOI",{});Q(this,"transformControls");Q(this,"ikSolver");Q(this,"iks",[]);Q(this,"start",!1);Q(this,"mirrorSphereCamera");Q(this,"conf",{followSphere:!1,turnHead:!0,ik_solver:!0});Q(this,"createGUI",n=>{const i=new ie;n.appendChild(i.domElement.parentElement);const o=this.conf;return i.add(o,"followSphere").name("follow sphere"),i.add(o,"turnHead").name("turn head"),i.add(o,"ik_solver").name("IK auto update"),i.add(this.ikSolver,"update").name("IK manual update()"),i.open(),()=>{i.destroy()}});Q(this,"initGLTF",async()=>{const n=new te;n.setDecoderPath(gt.substring(0,gt.lastIndexOf("/")+1));const i=new ee;i.setDRACOLoader(n);const o=await i.loadAsync("assets/models/gltf/kira.glb"),a=this.OOI;return o.scene.traverse(t=>{t.name==="head"&&(a.head=t),t.name==="lowerarm_l"&&(a.lowerarm_l=t),t.name==="Upperarm_l"&&(a.Upperarm_l=t),t.name==="hand_l"&&(a.hand_l=t),t.name==="target_hand_l"&&(a.target_hand_l=t),t.name==="boule"&&(a.sphere=t),t.name==="Kira_Shirt_left"&&(a.kira=t),t instanceof s&&t.isMesh&&(t.frustumCulled=!1)}),o});Q(this,"v0",new r)}init(n){super.init(n);const i=this.utils.createScene(14540253,null,[16777215,.17]);this.scene=i;const o=this.utils.createPerspectiveCamera({fov:55,near:.001,far:5e3},[.9728517749133652,1.1044765132727201,.7316689528482836],i.position.toArray());this.camera=o;const a=new Nt(16777215,8);i.add(a),this.renderer.physicallyCorrectLights=!0;const t=new $t(o,this.renderer.domElement);this.controls=t,t.minDistance=.2,t.maxDistance=1.5,t.enableDamping=!0;const c=()=>t.enabled=!1,h=()=>t.enabled=!0;let m;return this.initGLTF().then(p=>{i.add(p.scene),t.target.copy(this.OOI.sphere.position),this.OOI.hand_l.attach(this.OOI.sphere);const g=new Kt(1024),_=new Jt(.05,50,g);this.mirrorSphereCamera=_,i.add(_);const I=new W({envMap:g.texture});this.OOI.sphere.material=I;const b=new ne(o,this.renderer.domElement);this.transformControls=b,b.size=.75,b.showX=!1,b.space="world",b.attach(this.OOI.target_hand_l),i.add(b),b.addEventListener("mouseDown",c),b.addEventListener("mouseUp",h),this.OOI.kira.add(this.OOI.kira.skeleton.bones[0]),this.iks.push({target:22,effector:6,links:[{index:5,rotationMin:new r(1.2,-1.8,-.4),rotationMax:new r(1.7,-1.1,.3)},{index:4,rotationMin:new r(.1,-.7,-1.8),rotationMax:new r(1.1,0,-1.4)}]});const w=new de(this.OOI.kira,this.iks);this.ikSolver=w;const d=new Xt(this.OOI.kira,this.iks,.01);i.add(d),m=this.createGUI(n.ui),this.start=!0}),()=>{var p,g;(p=this.transformControls)==null||p.removeEventListener("mouseDown",c),(g=this.transformControls)==null||g.removeEventListener("mouseUp",h),m&&m()}}run(){var n,i;return this.start&&(this.mirrorSphereCamera&&(this.OOI.sphere.visible=!1,this.OOI.sphere.getWorldPosition(this.mirrorSphereCamera.position),this.mirrorSphereCamera.update(this.renderer,this.scene),this.OOI.sphere.visible=!0),this.conf.followSphere&&(this.OOI.sphere.getWorldPosition(this.v0),this.controls.target.lerp(this.v0,.1)),this.conf.turnHead&&(this.OOI.sphere.getWorldPosition(this.v0),this.OOI.head.lookAt(this.v0),this.OOI.head.rotation.set(this.OOI.head.rotation.x,this.OOI.head.rotation.y+Math.PI,this.OOI.head.rotation.z)),this.conf.ik_solver&&((n=this.ikSolver)==null||n.update()),(i=this.controls)==null||i.update(),this.renderer.render(this.scene,this.camera)),0}}export{ge as default};
